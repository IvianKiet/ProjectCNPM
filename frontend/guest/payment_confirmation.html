<!DOCTYPE html>
<html class="dark" lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>X√°c Nh·∫≠n Thanh To√°n - Scan&Order</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Epilogue:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#39E079",
                        "accent-coral": "#DB6F5A",
                        "background-light": "#f6f8f7",
                        "background-dark": "#122017",
                        "surface-dark": "#242427",
                        "success-green": "#22C55E"
                    },
                    fontFamily: {
                        display: "Epilogue"
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        lg: "1rem",
                        xl: "1.5rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style>
        body {
            font-family: 'Epilogue', sans-serif;
        }
        
        @keyframes scale-in {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .animate-scale-in {
            animation: scale-in 0.3s ease-out;
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            * { color: black !important; }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen">
    <div class="layout-container flex flex-col min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200 dark:border-white/10 no-print">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-primary p-1.5 sm:p-2 rounded-lg">
                        <svg class="size-5 sm:size-6 text-white" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-bold text-base sm:text-lg tracking-tight">Scan&Order</h1>
                    </div>
                </div>
                <div id="table-info-badge" class="h-10 px-6 flex items-center bg-primary/10 border border-primary/20 rounded-full text-primary font-bold text-sm tracking-wide uppercase">
                    Loading...
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-4xl mx-auto w-full px-4 sm:px-6 py-6 sm:py-10">
            <!-- Success Header -->
            <div class="text-center mb-8 sm:mb-12 animate-scale-in">
                <div class="inline-flex items-center justify-center size-20 sm:size-24 bg-success-green/10 text-success-green rounded-full mb-4 sm:mb-6">
                    <span class="material-symbols-outlined text-5xl sm:text-6xl">check_circle</span>
                </div>
                <h2 class="text-3xl sm:text-4xl font-black tracking-tight mb-2 sm:mb-3">X√°c nh·∫≠n thanh to√°n</h2>
                <p class="text-slate-500 dark:text-slate-400 text-base sm:text-lg">Vui l√≤ng xu·∫•t tr√¨nh h√≥a ƒë∆°n n√†y cho nh√¢n vi√™n thu ng√¢n</p>
            </div>

            <!-- Invoice Details Card -->
            <div class="bg-white dark:bg-surface-dark rounded-2xl sm:rounded-3xl border border-slate-200 dark:border-white/5 shadow-xl overflow-hidden mb-6 sm:mb-8">
                <!-- Invoice Header -->
                <div class="p-6 sm:p-8 border-b border-slate-200 dark:border-white/5 bg-slate-50/50 dark:bg-white/[0.02]">
                    <div class="grid grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">M√£ ƒë∆°n h√†ng</p>
                            <p id="order-id-display" class="font-bold text-base sm:text-lg">Loading...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">B√†n s·ªë</p>
                            <p id="table-number-display" class="font-bold text-base sm:text-lg">Loading...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Ph∆∞∆°ng th·ª©c</p>
                            <p id="payment-method-display" class="font-bold text-base sm:text-lg">Loading...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Th·ªùi gian</p>
                            <p id="payment-time-display" class="font-bold text-base sm:text-lg">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="p-6 sm:p-8">
                    <h3 class="font-bold text-lg sm:text-xl mb-4 sm:mb-6">Chi ti·∫øt ƒë∆°n h√†ng</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-slate-200 dark:border-white/10">
                                <tr class="text-left text-slate-500 dark:text-slate-400">
                                    <th class="pb-3 font-bold">M√≥n ƒÉn</th>
                                    <th class="pb-3 font-bold text-center">SL</th>
                                    <th class="pb-3 font-bold text-right">ƒê∆°n gi√°</th>
                                    <th class="pb-3 font-bold text-right">Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody id="order-items-list" class="divide-y divide-slate-100 dark:divide-white/5">
                                <!-- Items will be rendered here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals -->
                    <div class="mt-6 sm:mt-8 flex flex-col items-end gap-2 pt-4 sm:pt-6 border-t border-dashed border-slate-200 dark:border-white/10">
                        <div class="flex justify-between w-full max-w-xs text-slate-500 dark:text-slate-400 text-sm">
                            <span>T·∫°m t√≠nh</span>
                            <span id="confirm-subtotal">0ƒë</span>
                        </div>
                        <div class="flex justify-between w-full max-w-xs text-slate-500 dark:text-slate-400 text-sm">
                            <span>Thu·∫ø VAT (10%)</span>
                            <span id="confirm-vat">0ƒë</span>
                        </div>
                        <div class="flex justify-between w-full max-w-xs text-accent-coral text-sm">
                            <span>Gi·∫£m gi√°</span>
                            <span id="confirm-discount">-0ƒë</span>
                        </div>
                        <div class="flex justify-between w-full max-w-xs pt-3 border-t border-slate-200 dark:border-white/10">
                            <span class="font-bold text-base sm:text-lg">T·ªïng c·ªông</span>
                            <span id="confirm-total" class="font-black text-2xl sm:text-3xl text-primary">0ƒë</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Badge -->
            <div id="payment-status-badge" class="mb-6 sm:mb-8 p-4 sm:p-6 rounded-xl sm:rounded-2xl bg-primary/10 border-2 border-primary/20 text-center">
                <div class="flex items-center justify-center gap-3 mb-2">
                    <span class="material-symbols-outlined text-primary text-2xl">pending</span>
                    <p class="text-lg sm:text-xl font-black text-primary">Ch·ªù x√°c nh·∫≠n t·ª´ nh√¢n vi√™n</p>
                </div>
                <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400">Vui l√≤ng xu·∫•t tr√¨nh h√≥a ƒë∆°n n√†y t·∫°i qu·∫ßy thu ng√¢n ƒë·ªÉ ho√†n t·∫•t thanh to√°n</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 no-print">
                <button onclick="window.print()" class="flex-1 px-6 py-4 rounded-xl border-2 border-slate-300 dark:border-white/20 text-slate-700 dark:text-white font-bold hover:bg-slate-100 dark:hover:bg-white/10 transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">print</span>
                    In h√≥a ƒë∆°n
                </button>
                <button onclick="window.GuestUtils.navigateTo('menu.html')" class="flex-1 px-6 py-4 rounded-xl bg-primary text-background-dark font-bold hover:bg-primary/90 transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">restaurant</span>
                    Quay l·∫°i menu
                </button>
            </div>

            <!-- Info Note -->
            <div class="mt-6 sm:mt-8 flex items-start gap-3 p-3 sm:p-4 bg-blue-500/10 rounded-xl sm:rounded-2xl border border-blue-500/20">
                <span class="material-symbols-outlined text-blue-500 shrink-0 text-lg sm:text-2xl">info</span>
                <div class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                    <p class="font-bold mb-1">L∆∞u √Ω quan tr·ªçng:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Vui l√≤ng gi·ªØ l·∫°i h√≥a ƒë∆°n n√†y ƒë·ªÉ ƒë·ªëi chi·∫øu v·ªõi nh√¢n vi√™n</li>
                        <li>Thanh to√°n ch·ªâ ƒë∆∞·ª£c ho√†n t·∫•t sau khi nh√¢n vi√™n x√°c nh·∫≠n</li>
                        <li>N·∫øu c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá nh√¢n vi√™n ph·ª•c v·ª•</li>
                    </ul>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-auto py-6 sm:py-8 border-t border-slate-200 dark:border-white/5 no-print">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 text-center">
                <p class="text-sm text-slate-400">¬© 2024 Scan&Order. C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•.</p>
            </div>
        </footer>
    </div>

    <script src="../../assets/Javascript/guest/guest_utils.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + 'ƒë';
        }

        // Format time
        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Load confirmation data from localStorage
        function loadConfirmationData() {
            try {
                const confirmationData = localStorage.getItem('payment_confirmation_data');
                
                if (!confirmationData) {
                    console.error('No confirmation data found');
                    showError();
                    return;
                }

                const data = JSON.parse(confirmationData);
                console.log('‚úÖ Confirmation data loaded:', data);
                console.log('üì¶ Items structure:', data.items);
                
                // Log first item to see field names
                if (data.items && data.items.length > 0) {
                    console.log('üìù First item fields:', Object.keys(data.items[0]));
                }

                // Update header
                const tableBadge = document.getElementById('table-info-badge');
                if (tableBadge) {
                    tableBadge.textContent = `B√†n ${data.tableNumber || 'N/A'}`;
                }

                // Update invoice details
                document.getElementById('order-id-display').textContent = 
                    `#${data.orderId ? data.orderId.substring(0, 8).toUpperCase() : 'N/A'}`;
                
                document.getElementById('table-number-display').textContent = data.tableNumber || 'N/A';
                
                document.getElementById('payment-method-display').textContent = 
                    data.paymentMethod === 'qr' ? 'Chuy·ªÉn kho·∫£n QR' : 'Ti·ªÅn m·∫∑t t·∫°i qu·∫ßy';
                
                document.getElementById('payment-time-display').textContent = formatTime();

                // Render order items
                const itemsList = document.getElementById('order-items-list');
                itemsList.innerHTML = '';
                
                data.items.forEach(item => {
                    // Handle both field name variations from API
                    const itemName = item.menu_item_name || item.item_name || 'M√≥n ƒÉn';
                    const itemPrice = item.price || 0;
                    const itemQuantity = item.quantity || 1;
                    const itemNote = item.note || '';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3">
                            <div class="font-medium">${itemName}</div>
                            ${itemNote ? `<div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Ghi ch√∫: ${itemNote}</div>` : ''}
                        </td>
                        <td class="py-3 text-center">${itemQuantity}</td>
                        <td class="py-3 text-right">${formatCurrency(itemPrice)}</td>
                        <td class="py-3 text-right font-medium">${formatCurrency(itemPrice * itemQuantity)}</td>
                    `;
                    itemsList.appendChild(row);
                });

                // Update totals
                document.getElementById('confirm-subtotal').textContent = formatCurrency(data.subtotal);
                document.getElementById('confirm-vat').textContent = formatCurrency(data.vat);
                document.getElementById('confirm-discount').textContent = formatCurrency(data.discount);
                document.getElementById('confirm-total').textContent = formatCurrency(data.total);

            } catch (error) {
                console.error('‚ùå Error loading confirmation data:', error);
                showError();
            }
        }

        function showError() {
            document.querySelector('main').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <span class="material-symbols-outlined text-6xl text-red-500 mb-4">error</span>
                    <p class="text-xl font-bold mb-2">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin thanh to√°n</p>
                    <p class="text-slate-500 mb-6">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá nh√¢n vi√™n</p>
                    <button onclick="window.GuestUtils.navigateTo('menu.html')" class="px-6 py-3 bg-primary text-white rounded-xl font-bold">
                        Quay l·∫°i menu
                    </button>
                </div>
            `;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Loading payment confirmation page...');
            loadConfirmationData();
        });
    </script>
</body>
</html>